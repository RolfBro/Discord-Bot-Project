"use strict";
var __classPrivateFieldSet = (this && this.__classPrivateFieldSet) || function (receiver, state, value, kind, f) {
    if (kind === "m") throw new TypeError("Private method is not writable");
    if (kind === "a" && !f) throw new TypeError("Private accessor was defined without a setter");
    if (typeof state === "function" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError("Cannot write private member to an object whose class did not declare it");
    return (kind === "a" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;
};
var __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {
    if (kind === "a" && !f) throw new TypeError("Private accessor was defined without a getter");
    if (typeof state === "function" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError("Cannot read private member from an object whose class did not declare it");
    return kind === "m" ? f : kind === "a" ? f.call(receiver) : f ? f.value : state.get(receiver);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var _HttpClient_instances, _HttpClient_httpAgent, _HttpClient_httpsAgent, _HttpClient_localAddress, _HttpClient_defaultHeaders, _HttpClient_gzip, _HttpClient_decodeRequestOptions;
Object.defineProperty(exports, "__esModule", { value: true });
exports.preProcessOptions = void 0;
const events_1 = require("events");
const http_1 = require("http");
const https_1 = require("https");
const querystring_1 = require("querystring");
const zlib_1 = require("zlib");
const objects_1 = require("../../../objects");
const CookieJar_1 = __importDefault(require("./CookieJar"));
const crypto_1 = require("crypto");
const BODY_TYPES = ['body', 'urlEncodedForm', 'multipartForm', 'json'];
const METHODS_WITHOUT_BODY = ['GET', 'HEAD', 'OPTIONS', 'TRACE'];
const UTF8_PARSEABLE_CONTENT_TYPES = [
    // text/* is always considered parseable
    'application/json',
    'application/x-www-form-urlencoded',
    'application/xml',
    'application/xhtml+xml',
    'message/http' // for TRACE responses
];
const REDIRECT_STATUS_CODES = [301, 302, 303, 307, 308];
class HttpClient extends events_1.EventEmitter {
    constructor(options) {
        super();
        _HttpClient_instances.add(this);
        _HttpClient_httpAgent.set(this, void 0);
        _HttpClient_httpsAgent.set(this, void 0);
        _HttpClient_localAddress.set(this, void 0);
        _HttpClient_defaultHeaders.set(this, void 0);
        _HttpClient_gzip.set(this, void 0);
        options = options || {};
        __classPrivateFieldSet(this, _HttpClient_httpAgent, options.httpAgent || new http_1.Agent({ keepAlive: true }), "f");
        __classPrivateFieldSet(this, _HttpClient_httpsAgent, options.httpsAgent || new https_1.Agent({ keepAlive: true }), "f");
        __classPrivateFieldSet(this, _HttpClient_localAddress, options.localAddress, "f");
        __classPrivateFieldSet(this, _HttpClient_defaultHeaders, options.defaultHeaders || {}, "f");
        __classPrivateFieldSet(this, _HttpClient_gzip, options.gzip !== false, "f");
        if (options.cookieJar) {
            this.cookieJar = options.cookieJar === true ? new CookieJar_1.default() : options.cookieJar;
        }
    }
    request(options) {
        return new Promise((resolve, reject) => {
            options = preProcessOptions(options);
            createRequestBody(options);
            let nodeOptions = __classPrivateFieldGet(this, _HttpClient_instances, "m", _HttpClient_decodeRequestOptions).call(this, options);
            let reqFunc = nodeOptions.protocol == 'http:' ? http_1.request : https_1.request;
            this.emit('debug', 'request', `${nodeOptions.method} ${buildUrl(nodeOptions)}`, nodeOptions.headers);
            let req = reqFunc(nodeOptions, (res) => {
                let bodyChunks = [];
                let responseStream = res;
                if (res.headers['content-encoding'] == 'gzip') {
                    this.emit('debug', 'decompressing gzipped response');
                    let gzipStream = (0, zlib_1.createGunzip)();
                    responseStream.pipe(gzipStream);
                    responseStream = gzipStream;
                }
                responseStream.on('data', chunk => bodyChunks.push(chunk));
                responseStream.on('end', () => {
                    let response = {
                        statusCode: res.statusCode,
                        statusMessage: res.statusMessage,
                        url: buildUrl(nodeOptions),
                        headers: res.headers,
                        rawBody: Buffer.concat(bodyChunks)
                    };
                    this.emit('debug', 'response', `${nodeOptions.method} ${buildUrl(nodeOptions)} ${res.statusCode} ${res.statusMessage} ${res.headers['content-type']}`);
                    if (this.cookieJar) {
                        let setCookieHeader = response.headers['set-cookie'] || [];
                        if (!Array.isArray(setCookieHeader)) {
                            setCookieHeader = [setCookieHeader];
                        }
                        setCookieHeader.forEach((setCookie) => {
                            this.cookieJar.add(setCookie, nodeOptions.host);
                        });
                    }
                    let contentType = (res.headers['content-type'] || '').split(';')[0].trim();
                    if (contentType.startsWith('text/') || UTF8_PARSEABLE_CONTENT_TYPES.includes(contentType)) {
                        response.textBody = response.rawBody.toString('utf8');
                    }
                    if (contentType == 'application/json') {
                        try {
                            response.jsonBody = JSON.parse(response.textBody);
                        }
                        catch (ex) {
                            // don't care
                        }
                    }
                    if (options.followRedirects && REDIRECT_STATUS_CODES.includes(res.statusCode) && res.headers.location) {
                        let newRequest = (0, objects_1.clone)(options);
                        if ([301, 302, 303].includes(res.statusCode)) {
                            // Change the method to GET
                            newRequest.method = 'GET';
                            newRequest.url = res.headers.location;
                            delete newRequest.body;
                            delete newRequest.headers['content-type'];
                            delete newRequest.headers['content-length'];
                            this.request(newRequest).then(resolve).catch(reject);
                            return;
                        }
                    }
                    resolve(response);
                });
                res.on('error', reject);
            });
            req.end(options.body);
            req.on('error', reject);
        });
    }
    static simpleObjectToMultipartForm(obj) {
        let multipartForm = {};
        for (let i in obj) {
            multipartForm[i] = { content: obj[i] };
        }
        return multipartForm;
    }
}
exports.default = HttpClient;
_HttpClient_httpAgent = new WeakMap(), _HttpClient_httpsAgent = new WeakMap(), _HttpClient_localAddress = new WeakMap(), _HttpClient_defaultHeaders = new WeakMap(), _HttpClient_gzip = new WeakMap(), _HttpClient_instances = new WeakSet(), _HttpClient_decodeRequestOptions = function _HttpClient_decodeRequestOptions(options) {
    let nodeOptions = {};
    let url = new URL(options.url);
    let queryString = url.search;
    if (options.queryString) {
        if (queryString.length == 0) {
            queryString += '?';
        }
        if (!queryString.endsWith('?')) {
            // If the final character of our query string isn't "?", then we need to append a "&" to separate our new
            // options from existing options.
            queryString += '&';
        }
        queryString += (0, querystring_1.stringify)(options.queryString);
    }
    nodeOptions.protocol = url.protocol;
    nodeOptions.host = url.hostname;
    nodeOptions.port = getPort(url.port, url.protocol);
    nodeOptions.path = url.pathname + queryString;
    nodeOptions.method = options.method;
    nodeOptions.agent = url.protocol == 'http:' ? __classPrivateFieldGet(this, _HttpClient_httpAgent, "f") : __classPrivateFieldGet(this, _HttpClient_httpsAgent, "f");
    nodeOptions.localAddress = __classPrivateFieldGet(this, _HttpClient_localAddress, "f");
    nodeOptions.headers = { ...__classPrivateFieldGet(this, _HttpClient_defaultHeaders, "f"), ...(options.headers || {}) };
    if (this.cookieJar) {
        let cookieHeaderValue = this.cookieJar.getCookieHeaderForUrl(options.url);
        if (cookieHeaderValue.length > 0) {
            let existingCookieHeader = options.headers.cookie;
            nodeOptions.headers.cookie = (existingCookieHeader ? `${existingCookieHeader}; ` : '') + cookieHeaderValue;
        }
    }
    if (__classPrivateFieldGet(this, _HttpClient_gzip, "f")) {
        nodeOptions.headers['accept-encoding'] = 'gzip';
    }
    return nodeOptions;
};
function getPort(portStr, protocol) {
    let port = parseInt(portStr);
    if (isNaN(port) || port == 0) {
        return protocol == 'http:' ? 80 : 443;
    }
    return port;
}
function preProcessOptions(options) {
    // deep-clone the object so we don't cause any problems with implementation code
    options = (0, objects_1.clone)(options);
    options.method = options.method.toUpperCase();
    options.headers = options.headers || {};
    // lowercase all the header names
    let normalizedHeaders = {};
    for (let i in options.headers) {
        let nameLower = i.toLowerCase();
        if (normalizedHeaders[nameLower]) {
            throw new Error(`Header "${nameLower}" appears in the headers object multiple times, with different capitalization`);
        }
        normalizedHeaders[nameLower] = options.headers[i];
    }
    options.headers = normalizedHeaders;
    // Only 1 body type may be specified. If more than 1 is present, that's an error.
    if (BODY_TYPES.filter(bt => typeof options[bt] != 'undefined').length > 1) {
        throw new Error('Multiple body types were specified. Only 1 of body, urlEncodedForm, multipartForm, json may be specified');
    }
    return options;
}
exports.preProcessOptions = preProcessOptions;
function createRequestBody(options) {
    let bodyBuffer = Buffer.alloc(0);
    if (options.body) {
        bodyBuffer = Buffer.isBuffer(options.body) ? options.body : Buffer.from(options.body, 'utf8');
    }
    if (options.urlEncodedForm) {
        bodyBuffer = Buffer.from((0, querystring_1.stringify)(options.urlEncodedForm), 'utf8');
        options.headers['content-type'] = 'application/x-www-form-urlencoded';
    }
    if (options.json) {
        bodyBuffer = Buffer.from(JSON.stringify(options.json), 'utf8');
        options.headers['content-type'] = 'application/json';
    }
    if (options.multipartForm) {
        let boundary = '-----------------------------' + (0, crypto_1.randomBytes)(20).toString('hex');
        options.headers['content-type'] = `multipart/form-data; boundary=${boundary}`;
        let encodedBodyParts = [];
        for (let i in options.multipartForm) {
            let formObject = options.multipartForm[i];
            let head = `--${boundary}\r\nContent-Disposition: form-data; name="${i}"` +
                (formObject.filename ? `; filename="${formObject.filename}"` : '') +
                (formObject.contentType ? `\r\nContent-Type: ${formObject.contentType}` : '') +
                '\r\n\r\n';
            let tail = '\r\n';
            encodedBodyParts = encodedBodyParts.concat([
                Buffer.from(head, 'utf8'),
                Buffer.isBuffer(formObject.content) ? formObject.content : Buffer.from(formObject.content, 'utf8'),
                Buffer.from(tail, 'utf8')
            ]);
        }
        encodedBodyParts.push(Buffer.from(`--${boundary}--\r\n`, 'utf8'));
        bodyBuffer = Buffer.concat(encodedBodyParts);
    }
    if (METHODS_WITHOUT_BODY.includes(options.method)) {
        if (bodyBuffer.length > 0) {
            throw new Error(`Requests with method "${options.method} may not have a request body`);
        }
        delete options.headers['content-type'];
        delete options.headers['content-length'];
        return;
    }
    delete options.urlEncodedForm;
    delete options.json;
    delete options.multipartForm;
    options.body = bodyBuffer;
    options.headers['content-length'] = options.body.length;
}
function buildUrl(urlObj) {
    let portAppend = (urlObj.protocol == 'http:' && urlObj.port != 80) ||
        (urlObj.protocol == 'https:' && urlObj.port != 443);
    return `${urlObj.protocol}//${urlObj.host}${portAppend ? `:${urlObj.port}` : ''}${urlObj.path}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSHR0cENsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvaHR0cC9jbGllbnQvSHR0cENsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxtQ0FBb0M7QUFDcEMsK0JBQXNHO0FBQ3RHLGlDQUFtRTtBQUNuRSw2Q0FBMkQ7QUFDM0QsK0JBQWtDO0FBR2xDLDhDQUF1QztBQUN2Qyw0REFBb0M7QUFFcEMsbUNBQW1DO0FBRW5DLE1BQU0sVUFBVSxHQUFHLENBQUMsTUFBTSxFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN2RSxNQUFNLG9CQUFvQixHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDakUsTUFBTSw0QkFBNEIsR0FBRztJQUNwQyx3Q0FBd0M7SUFDeEMsa0JBQWtCO0lBQ2xCLG1DQUFtQztJQUNuQyxpQkFBaUI7SUFDakIsdUJBQXVCO0lBQ3ZCLGNBQWMsQ0FBQyxzQkFBc0I7Q0FDckMsQ0FBQztBQUNGLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFFeEQsTUFBcUIsVUFBVyxTQUFRLHFCQUFZO0lBU25ELFlBQVksT0FBMkI7UUFDdEMsS0FBSyxFQUFFLENBQUM7O1FBUFQsd0NBQXNCO1FBQ3RCLHlDQUF3QjtRQUN4QiwyQ0FBdUI7UUFDdkIsNkNBQWlEO1FBQ2pELG1DQUFlO1FBS2QsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFFeEIsdUJBQUEsSUFBSSx5QkFBYyxPQUFPLENBQUMsU0FBUyxJQUFJLElBQUksWUFBUyxDQUFDLEVBQUMsU0FBUyxFQUFFLElBQUksRUFBQyxDQUFDLE1BQUEsQ0FBQztRQUN4RSx1QkFBQSxJQUFJLDBCQUFlLE9BQU8sQ0FBQyxVQUFVLElBQUksSUFBSSxhQUFVLENBQUMsRUFBQyxTQUFTLEVBQUUsSUFBSSxFQUFDLENBQUMsTUFBQSxDQUFDO1FBQzNFLHVCQUFBLElBQUksNEJBQWlCLE9BQU8sQ0FBQyxZQUFZLE1BQUEsQ0FBQztRQUMxQyx1QkFBQSxJQUFJLDhCQUFtQixPQUFPLENBQUMsY0FBYyxJQUFJLEVBQUUsTUFBQSxDQUFDO1FBQ3BELHVCQUFBLElBQUksb0JBQVMsT0FBTyxDQUFDLElBQUksS0FBSyxLQUFLLE1BQUEsQ0FBQztRQUVwQyxJQUFJLE9BQU8sQ0FBQyxTQUFTLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxtQkFBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7U0FDbEY7SUFDRixDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQTJCO1FBQ2xDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDdEMsT0FBTyxHQUFHLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRTNCLElBQUksV0FBVyxHQUFHLHVCQUFBLElBQUksK0RBQXNCLE1BQTFCLElBQUksRUFBdUIsT0FBTyxDQUFDLENBQUM7WUFDdEQsSUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLGNBQVcsQ0FBQyxDQUFDLENBQUMsZUFBWSxDQUFDO1lBQzNFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLFdBQVcsQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXJHLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDdEMsSUFBSSxVQUFVLEdBQVksRUFBRSxDQUFDO2dCQUM3QixJQUFJLGNBQWMsR0FBWSxHQUFHLENBQUM7Z0JBRWxDLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLE1BQU0sRUFBRTtvQkFDOUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsZ0NBQWdDLENBQUMsQ0FBQztvQkFDckQsSUFBSSxVQUFVLEdBQUcsSUFBQSxtQkFBWSxHQUFFLENBQUM7b0JBQ2hDLGNBQWMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQ2hDLGNBQWMsR0FBRyxVQUFVLENBQUM7aUJBQzVCO2dCQUVELGNBQWMsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUMzRCxjQUFjLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUU7b0JBQzdCLElBQUksUUFBUSxHQUFnQjt3QkFDM0IsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVO3dCQUMxQixhQUFhLEVBQUUsR0FBRyxDQUFDLGFBQWE7d0JBQ2hDLEdBQUcsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDO3dCQUMxQixPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQW1DO3dCQUNoRCxPQUFPLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUM7cUJBQ2xDLENBQUM7b0JBRUYsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsV0FBVyxDQUFDLE1BQU0sSUFBSSxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxDQUFDLFVBQVUsSUFBSSxHQUFHLENBQUMsYUFBYSxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUV2SixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7d0JBQ25CLElBQUksZUFBZSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO3dCQUMzRCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRTs0QkFDcEMsZUFBZSxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7eUJBQ3BDO3dCQUNELGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTs0QkFDckMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDakQsQ0FBQyxDQUFDLENBQUM7cUJBQ0g7b0JBRUQsSUFBSSxXQUFXLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztvQkFDM0UsSUFBSSxXQUFXLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLDRCQUE0QixDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFBRTt3QkFDMUYsUUFBUSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztxQkFDdEQ7b0JBRUQsSUFBSSxXQUFXLElBQUksa0JBQWtCLEVBQUU7d0JBQ3RDLElBQUk7NEJBQ0gsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQzt5QkFDbEQ7d0JBQUMsT0FBTyxFQUFFLEVBQUU7NEJBQ1osYUFBYTt5QkFDYjtxQkFDRDtvQkFFRCxJQUFJLE9BQU8sQ0FBQyxlQUFlLElBQUkscUJBQXFCLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRTt3QkFDdEcsSUFBSSxVQUFVLEdBQUcsSUFBQSxlQUFLLEVBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ2hDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUU7NEJBQzdDLDJCQUEyQjs0QkFDM0IsVUFBVSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7NEJBQzFCLFVBQVUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7NEJBQ3RDLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQzs0QkFDdkIsT0FBTyxVQUFVLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDOzRCQUMxQyxPQUFPLFVBQVUsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQzs0QkFDNUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDOzRCQUNyRCxPQUFPO3lCQUNQO3FCQUNEO29CQUVELE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDbkIsQ0FBQyxDQUFDLENBQUM7Z0JBRUgsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDekIsQ0FBQyxDQUFDLENBQUM7WUFFSCxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QixHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUErQ0QsTUFBTSxDQUFDLDJCQUEyQixDQUFDLEdBQW9DO1FBQ3RFLElBQUksYUFBYSxHQUF5QyxFQUFFLENBQUM7UUFDN0QsS0FBSyxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUU7WUFDbEIsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBQyxDQUFDO1NBQ3JDO1FBQ0QsT0FBTyxhQUFhLENBQUM7SUFDdEIsQ0FBQztDQUNEO0FBN0pELDZCQTZKQzsyVEFwRHNCLE9BQTJCO0lBQ2hELElBQUksV0FBVyxHQUFzQixFQUFFLENBQUM7SUFFeEMsSUFBSSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRS9CLElBQUksV0FBVyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFDN0IsSUFBSSxPQUFPLENBQUMsV0FBVyxFQUFFO1FBQ3hCLElBQUksV0FBVyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDNUIsV0FBVyxJQUFJLEdBQUcsQ0FBQztTQUNuQjtRQUVELElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQy9CLHlHQUF5RztZQUN6RyxpQ0FBaUM7WUFDakMsV0FBVyxJQUFJLEdBQUcsQ0FBQztTQUNuQjtRQUVELFdBQVcsSUFBSSxJQUFBLHVCQUFpQixFQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztLQUN0RDtJQUVELFdBQVcsQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQztJQUNwQyxXQUFXLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFDaEMsV0FBVyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkQsV0FBVyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQztJQUU5QyxXQUFXLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDcEMsV0FBVyxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsdUJBQUEsSUFBSSw2QkFBVyxDQUFDLENBQUMsQ0FBQyx1QkFBQSxJQUFJLDhCQUFZLENBQUM7SUFDakYsV0FBVyxDQUFDLFlBQVksR0FBRyx1QkFBQSxJQUFJLGdDQUFjLENBQUM7SUFDOUMsV0FBVyxDQUFDLE9BQU8sR0FBRyxFQUFDLEdBQUcsdUJBQUEsSUFBSSxrQ0FBZ0IsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsRUFBQyxDQUFDO0lBRTVFLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUNuQixJQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFFLElBQUksaUJBQWlCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNqQyxJQUFJLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1lBQ2xELFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLEdBQUcsb0JBQW9CLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsaUJBQWlCLENBQUM7U0FDM0c7S0FDRDtJQUVELElBQUksdUJBQUEsSUFBSSx3QkFBTSxFQUFFO1FBQ2YsV0FBVyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLE1BQU0sQ0FBQztLQUNoRDtJQUVELE9BQU8sV0FBVyxDQUFDO0FBQ3BCLENBQUM7QUFXRixTQUFTLE9BQU8sQ0FBQyxPQUFlLEVBQUUsUUFBZ0I7SUFDakQsSUFBSSxJQUFJLEdBQVUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3BDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEVBQUU7UUFDN0IsT0FBTyxRQUFRLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztLQUN0QztJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2IsQ0FBQztBQUVELFNBQWdCLGlCQUFpQixDQUFDLE9BQTJCO0lBQzVELGdGQUFnRjtJQUNoRixPQUFPLEdBQUcsSUFBQSxlQUFLLEVBQUMsT0FBTyxDQUFDLENBQUM7SUFDekIsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQzlDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFFeEMsaUNBQWlDO0lBQ2pDLElBQUksaUJBQWlCLEdBQXlCLEVBQUUsQ0FBQztJQUNqRCxLQUFLLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUU7UUFDOUIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2hDLElBQUksaUJBQWlCLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLFNBQVMsK0VBQStFLENBQUMsQ0FBQztTQUNySDtRQUVELGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDbEQ7SUFFRCxPQUFPLENBQUMsT0FBTyxHQUFHLGlCQUFpQixDQUFDO0lBRXBDLGlGQUFpRjtJQUNqRixJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxXQUFXLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQzFFLE1BQU0sSUFBSSxLQUFLLENBQUMsMEdBQTBHLENBQUMsQ0FBQztLQUM1SDtJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUM7QUF6QkQsOENBeUJDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxPQUEyQjtJQUNyRCxJQUFJLFVBQVUsR0FBVSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXhDLElBQUksT0FBTyxDQUFDLElBQUksRUFBRTtRQUNqQixVQUFVLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztLQUM5RjtJQUVELElBQUksT0FBTyxDQUFDLGNBQWMsRUFBRTtRQUMzQixVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFBLHVCQUFpQixFQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1RSxPQUFPLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxHQUFHLG1DQUFtQyxDQUFDO0tBQ3RFO0lBRUQsSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFO1FBQ2pCLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQy9ELE9BQU8sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEdBQUcsa0JBQWtCLENBQUM7S0FDckQ7SUFFRCxJQUFJLE9BQU8sQ0FBQyxhQUFhLEVBQUU7UUFDMUIsSUFBSSxRQUFRLEdBQUcsK0JBQStCLEdBQUcsSUFBQSxvQkFBVyxFQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqRixPQUFPLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxHQUFHLGlDQUFpQyxRQUFRLEVBQUUsQ0FBQztRQUU5RSxJQUFJLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUMxQixLQUFLLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxhQUFhLEVBQUU7WUFDcEMsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxJQUFJLElBQUksR0FBRyxLQUFLLFFBQVEsNkNBQTZDLENBQUMsR0FBRztnQkFDeEUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxlQUFlLFVBQVUsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUNsRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLHFCQUFxQixVQUFVLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDN0UsVUFBVSxDQUFDO1lBQ1osSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDO1lBRWxCLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQztnQkFDMUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDO2dCQUN6QixNQUFNLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQztnQkFDbEcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDO2FBQ3pCLENBQUMsQ0FBQztTQUNIO1FBRUQsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxRQUFRLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7S0FDN0M7SUFFRCxJQUFJLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDbEQsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixPQUFPLENBQUMsTUFBTSw4QkFBOEIsQ0FBQyxDQUFDO1NBQ3ZGO1FBRUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3ZDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3pDLE9BQU87S0FDUDtJQUVELE9BQU8sT0FBTyxDQUFDLGNBQWMsQ0FBQztJQUM5QixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDcEIsT0FBTyxPQUFPLENBQUMsYUFBYSxDQUFDO0lBQzdCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDO0lBRTFCLE9BQU8sQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUN6RCxDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsTUFBVztJQUM1QixJQUFJLFVBQVUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLElBQUksT0FBTyxJQUFJLE1BQU0sQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ2pFLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxRQUFRLElBQUksTUFBTSxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztJQUVyRCxPQUFPLEdBQUcsTUFBTSxDQUFDLFFBQVEsS0FBSyxNQUFNLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDakcsQ0FBQyJ9