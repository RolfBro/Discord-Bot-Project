"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const crypto_1 = require("crypto");
const debug_1 = __importDefault(require("debug"));
const vdf_1 = __importDefault(require("vdf"));
const websocket13_1 = require("websocket13");
const zlib_1 = __importDefault(require("zlib"));
const EMsg_1 = __importDefault(require("../enums-steam/EMsg"));
const EResult_1 = __importDefault(require("../enums-steam/EResult"));
const load_1 = __importDefault(require("../protobuf-generated/load"));
const helpers_1 = require("../helpers");
const debug = (0, debug_1.default)('steam-session:WebSocketCMTransport');
const debugVerbose = debug.extend('verbose');
const PROTOCOL_VERSION = 65580;
const PROTO_MASK = 0x80000000;
class WebSocketCMTransport {
    constructor(webClient, agent) {
        this._connectTimeout = 1000;
        this._clientSessionId = 0;
        this._webClient = webClient;
        this._agent = agent;
        this._websocket = null;
        this._jobs = {};
    }
    async sendRequest(request) {
        for (let tryCount = 1; tryCount <= 3; tryCount++) {
            try {
                let targetName = `${request.apiInterface}.${request.apiMethod}#${request.apiVersion}`;
                return await this._sendMessage(EMsg_1.default.ServiceMethodCallFromClientNonAuthed, request.requestData, targetName);
            }
            catch (ex) {
                if (ex.eresult && [EResult_1.default.TryAnotherCM, EResult_1.default.ServiceUnavailable].includes(ex.eresult)) {
                    continue;
                }
                throw ex;
            }
        }
    }
    close() {
        if (this._websocket && this._websocket.state == websocket13_1.State.Connected) {
            this._websocket.disconnect();
        }
    }
    _connectToCM() {
        return new Promise(async (resolve, reject) => {
            try {
                if (this._websocket && this._websocket.state == websocket13_1.State.Connecting) {
                    // Just wait for the previous connection attempt to succeed
                    let connected, error;
                    connected = () => {
                        this._websocket.removeListener('error', error);
                        resolve();
                    };
                    error = (err) => {
                        this._websocket.removeListener('connected', connected);
                        reject(err);
                    };
                    this._websocket.once('connected', connected);
                    this._websocket.once('error', error);
                    return;
                }
                debug('_connectToCM()');
                let cmList = (await this._fetchCMList())
                    .filter(cm => cm.type == 'websockets' && cm.realm == 'steamglobal');
                // Choose a CM at random
                let randUpperBound = Math.min(20, cmList.length);
                let cm = cmList[Math.floor(Math.random() * randUpperBound)];
                debug(`Connecting to ${cm.endpoint}`);
                let resolved = false;
                this._websocket = new websocket13_1.WebSocket(`wss://${cm.endpoint}/cmsocket/`, {
                    connection: {
                        agent: this._agent
                    }
                });
                this._websocket.setTimeout(this._connectTimeout);
                this._websocket.on('timeout', () => {
                    if (resolved) {
                        return;
                    }
                    debug(`Connecting to ${cm.endpoint} timed out after ${this._connectTimeout} ms`);
                    this._connectTimeout = Math.min(10000, this._connectTimeout * 2);
                    this._websocket.disconnect();
                    this._connectToCM().then(resolve).catch(reject);
                });
                this._websocket.on('connected', async () => {
                    this._websocket.setTimeout(0);
                    debug(`Connected to ${cm.endpoint}`);
                    let hello = { protocol_version: PROTOCOL_VERSION };
                    // @ts-ignore
                    await this._sendMessage(EMsg_1.default.ClientHello, load_1.default.CMsgClientHello.encode(hello).finish());
                    resolved = true;
                    resolve();
                });
                this._websocket.on('disconnected', (code, reason, initiatedByUs) => {
                    debug(`${initiatedByUs ? 'Disconnected' : 'Unexpectedly disconnected'} from ${cm.endpoint}: ${code} (${reason})`);
                    this._websocket = null;
                });
                this._websocket.on('error', (err) => {
                    debug(`Error ${resolved ? 'in' : 'connecting'} WebSocket with ${cm.endpoint}`);
                    if (!resolved) {
                        reject(err);
                    }
                });
                this._websocket.on('message', (type, msg) => {
                    if (type != websocket13_1.FrameType.Data.Binary) {
                        debug(`Received unexpected frame type from ${cm.endpoint}: ${type.toString(16)}`);
                        return;
                    }
                    this._handleWsMessage(msg);
                });
            }
            catch (ex) {
                reject(ex);
            }
        });
    }
    async _fetchCMList() {
        debug('Fetching CM list');
        let result = await this._webClient.request({
            method: 'GET',
            url: 'https://api.steampowered.com/ISteamDirectory/GetCMListForConnect/v0001/?cellid=0&format=vdf',
            headers: {
                'user-agent': 'Valve/Steam HTTP Client 1.0',
                'accept-charset': 'ISO-8859-1,utf-8,*;q=0.7',
                accept: 'text/html,*/*;q=0.9'
            }
        });
        if (result.statusCode != 200) {
            let err = new Error('Unable to fetch CM list');
            err.code = result.statusCode;
            throw err;
        }
        let parsedResult = vdf_1.default.parse(result.textBody);
        if (!parsedResult.response || !parsedResult.response.serverlist) {
            throw new Error('Malformed CM list response');
        }
        if (parsedResult.response.success != 1) {
            throw new Error(parsedResult.response.message || 'GetCMListForConnect failure');
        }
        let serverList = parsedResult.response.serverlist;
        serverList.length = Object.keys(serverList).length;
        /** @var {CmServer[]} serverList */
        serverList = Array.prototype.slice.call(serverList);
        serverList.forEach((server) => {
            server.load = parseFloat(server.load);
            server.wtd_load = parseFloat(server.wtd_load);
        });
        serverList.sort((a, b) => a.wtd_load < b.wtd_load ? -1 : 1);
        debug(`Fetched ${serverList.length} CMs`);
        return Array.prototype.slice.call(serverList);
    }
    _handleWsMessage(msg) {
        let rawEmsg = msg.readUInt32LE(0);
        let hdrLength = msg.readUInt32LE(4);
        let hdrBuf = msg.slice(8, 8 + hdrLength);
        let msgBody = msg.slice(8 + hdrLength);
        if (!(rawEmsg & PROTO_MASK)) {
            throw new Error(`Received unexpected non-protobuf message ${rawEmsg}`);
        }
        // @ts-ignore
        let decodedProtoHeader = load_1.default.CMsgProtoBufHeader.decode(hdrBuf);
        // @ts-ignore
        let protoHeader = load_1.default.CMsgProtoBufHeader.toObject(decodedProtoHeader, { longs: String });
        if (protoHeader.client_sessionid && protoHeader.client_sessionid != this._clientSessionId) {
            debugVerbose(`Got new client session id ${protoHeader.client_sessionid}`);
            this._clientSessionId = protoHeader.client_sessionid;
        }
        let eMsg = (rawEmsg & ~PROTO_MASK);
        if (eMsg != EMsg_1.default.Multi) {
            debugVerbose(`Receive: ${EMsg_1.default[eMsg] || eMsg} (${protoHeader.target_job_name})`);
        }
        if (protoHeader.jobid_target && this._jobs[protoHeader.jobid_target]) {
            let { resolve, timeout } = this._jobs[protoHeader.jobid_target];
            clearTimeout(timeout);
            delete this._jobs[protoHeader.jobid_target];
            let response = {
                result: protoHeader.eresult,
                errorMessage: protoHeader.error_message,
                responseData: msgBody
            };
            return resolve(response);
        }
        // this isn't a response message, so figure out what it is
        switch (eMsg) {
            case EMsg_1.default.ClientLogOnResponse:
                // The only time we expect to receive ClientLogOnResponse is when the CM is telling us to try another CM
                // @ts-ignore
                let decodedLogOnResponse = load_1.default.CMsgClientLogonResponse.decode(msgBody);
                // @ts-ignore
                let logOnResponse = load_1.default.CMsgClientLogonResponse.toObject(decodedLogOnResponse, { longs: String });
                debug(`Received ClientLogOnResponse with result: ${EResult_1.default[logOnResponse.eresult] || logOnResponse.eresult}`);
                if (this._websocket.state == websocket13_1.State.Connected) {
                    this._websocket.disconnect();
                    this._websocket = null;
                }
                for (let i in this._jobs) {
                    let { reject, timeout } = this._jobs[i];
                    clearTimeout(timeout);
                    reject((0, helpers_1.eresultError)(logOnResponse.eresult));
                }
                break;
            case EMsg_1.default.Multi:
                // noinspection JSIgnoredPromiseFromCall
                this._processMultiMsg(msgBody);
                break;
            default:
                debug(`Received unexpected message: ${eMsg}`);
        }
    }
    async _processMultiMsg(body) {
        // @ts-ignore
        let decodedBody = load_1.default.CMsgMulti.decode(body);
        // @ts-ignore
        let multi = load_1.default.CMsgMulti.toObject(decodedBody, { longs: String });
        let payload = multi.message_body;
        if (multi.size_unzipped) {
            // We need to decompress it
            payload = await new Promise((resolve, reject) => {
                zlib_1.default.gunzip(payload, (err, unzipped) => {
                    if (err) {
                        return reject(err);
                    }
                    resolve(unzipped);
                });
            });
        }
        while (payload.length > 0) {
            let chunkSize = payload.readUInt32LE(0);
            this._handleWsMessage(payload.slice(4, 4 + chunkSize));
            payload = payload.slice(4 + chunkSize);
        }
    }
    async _sendMessage(eMsg, body, serviceMethodName) {
        if (!this._websocket || this._websocket.state != websocket13_1.State.Connected) {
            await this._connectToCM();
        }
        return await new Promise((resolve, reject) => {
            let protoHeader = {
                steamid: '0',
                client_sessionid: eMsg != EMsg_1.default.ServiceMethodCallFromClientNonAuthed ? this._clientSessionId : 0,
            };
            if (eMsg == EMsg_1.default.ServiceMethodCallFromClientNonAuthed) {
                let jobIdBuffer = (0, crypto_1.randomBytes)(8);
                jobIdBuffer[0] &= 0x7f; // make sure it's always a positive value
                let jobId = jobIdBuffer.readBigInt64BE(0).toString(10);
                protoHeader.jobid_source = jobId;
                protoHeader.target_job_name = serviceMethodName;
                protoHeader.realm = 1;
                let timeout = setTimeout(() => {
                    reject(new Error(`Request ${serviceMethodName} timed out`));
                }, 5000);
                this._jobs[jobId] = { resolve, reject, timeout };
            }
            else {
                // There's no response, so just resolve right now
                resolve(undefined);
            }
            // @ts-ignore
            let encodedProtoHeader = load_1.default.CMsgProtoBufHeader.encode(protoHeader).finish();
            let header = Buffer.alloc(8);
            header.writeUInt32LE((eMsg | PROTO_MASK) >>> 0, 0);
            header.writeUInt32LE(encodedProtoHeader.length, 4);
            debugVerbose(`Send: ${EMsg_1.default[eMsg] || eMsg} (${serviceMethodName})`);
            this._websocket.send(Buffer.concat([
                header,
                encodedProtoHeader,
                body
            ]));
        });
    }
}
exports.default = WebSocketCMTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0Q01UcmFuc3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdHJhbnNwb3J0cy9XZWJTb2NrZXRDTVRyYW5zcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1DQUFtQztBQUNuQyxrREFBZ0M7QUFHaEMsOENBQXNCO0FBQ3RCLDZDQUFrRjtBQUNsRixnREFBd0I7QUFFeEIsK0RBQXVDO0FBQ3ZDLHFFQUE2QztBQUU3QyxzRUFBZ0Q7QUFHaEQsd0NBQXdDO0FBRXhDLE1BQU0sS0FBSyxHQUFHLElBQUEsZUFBVyxFQUFDLG9DQUFvQyxDQUFDLENBQUM7QUFDaEUsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUU3QyxNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQztBQUMvQixNQUFNLFVBQVUsR0FBRyxVQUFVLENBQUM7QUFZOUIsTUFBcUIsb0JBQW9CO0lBUXhDLFlBQVksU0FBcUIsRUFBRSxLQUFZO1FBUC9DLG9CQUFlLEdBQUcsSUFBSSxDQUFDO1FBS3ZCLHFCQUFnQixHQUFHLENBQUMsQ0FBQztRQUdwQixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFtQjtRQUNwQyxLQUFLLElBQUksUUFBUSxHQUFHLENBQUMsRUFBRSxRQUFRLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBQ2pELElBQUk7Z0JBQ0gsSUFBSSxVQUFVLEdBQUcsR0FBRyxPQUFPLENBQUMsWUFBWSxJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO2dC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